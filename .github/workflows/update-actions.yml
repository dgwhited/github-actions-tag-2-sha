name: Update GitHub Actions (Reusable)

on:
  workflow_call:
    inputs:
      files:
        description: 'Workflow files to process'
        type: string
        required: false
        default: '.github/workflows/*.yml'
      
      mode:
        description: 'Update mode: convert-to-sha, update-to-latest, or convert-main-to-release'
        type: string
        required: false
        default: 'update-to-latest'
      
      dry-run:
        description: 'Print changes without modifying files'
        type: boolean
        required: false
        default: false
      
      create-pr:
        description: 'Create a pull request with the changes'
        type: boolean
        required: false
        default: true
      
      pr-title:
        description: 'Pull request title'
        type: string
        required: false
        default: 'Update GitHub Actions to latest releases'
      
      pr-body:
        description: 'Pull request body'
        type: string
        required: false
        default: |
          ## 🤖 Automated GitHub Actions Update
          
          This PR updates GitHub Actions in workflow files to their latest releases for improved security and features.
          
          ### Changes Made
          - Updated actions to use SHA references with latest release tags
          - Maintained backwards compatibility
          - Added security improvements through SHA pinning
          
          **Generated by**: [github-actions-tag-2-sha](https://github.com/dgwhited/github-actions-tag-2-sha)
          
          Please review the changes and merge if everything looks good! 🚀
      
      pr-labels:
        description: 'Pull request labels (comma-separated)'
        type: string
        required: false
        default: 'dependencies, automated-pr, github-actions'
      
      commit-message:
        description: 'Commit message for changes'
        type: string
        required: false
        default: 'Update GitHub Actions to latest releases'
      
      branch-name:
        description: 'Branch name for the pull request'
        type: string
        required: false
        default: 'update-github-actions'

    secrets:
      token:
        description: 'GitHub token with workflow permissions (optional - uses GITHUB_TOKEN by default)'
        required: false

    outputs:
      changes-made:
        description: 'Number of changes made'
        value: ${{ jobs.update-actions.outputs.changes-made }}
      
      pull-request-number:
        description: 'Pull request number (if created)'
        value: ${{ jobs.update-actions.outputs.pull-request-number }}
      
      pull-request-url:
        description: 'Pull request URL (if created)'
        value: ${{ jobs.update-actions.outputs.pull-request-url }}

jobs:
  update-actions:
    runs-on: ubuntu-latest
    outputs:
      changes-made: ${{ steps.update.outputs.changes-made }}
      pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
      pull-request-url: ${{ steps.create-pr.outputs.pull-request-url }}
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Check token permissions for workflow files
        if: ${{ contains(inputs.files, '.github/workflows/') && !secrets.token }}
        run: |
          echo "::error::❌ Cannot update workflow files with default GITHUB_TOKEN"
          echo ""
          echo "⚠️  GitHub security prevents updating .github/workflows/ files without proper permissions."
          echo ""
          echo "🔧 TO FIX THIS:"
          echo "1. Create a Personal Access Token:"
          echo "   → Go to: https://github.com/settings/tokens/new"
          echo "   → Name: 'GitHub Actions Updater'"
          echo "   → Scope: ✅ repo (includes workflow permissions)"
          echo ""
          echo "2. Add token to repository secrets:"
          echo "   → Settings → Secrets and variables → Actions"
          echo "   → New repository secret: WORKFLOW_TOKEN"
          echo ""
          echo "3. Update your workflow:"
          echo "   secrets:"
          echo "     token: \${{ secrets.WORKFLOW_TOKEN }}"
          echo ""
          echo "📖 See README for complete setup guide"
          exit 1

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.token || github.token }}
          fetch-depth: 0
      
      - name: Update GitHub Actions
        id: update
        uses: ./
        with:
          files: ${{ inputs.files }}
          mode: ${{ inputs.mode }}
          token: ${{ secrets.token || github.token }}
          dry-run: ${{ inputs.dry-run }}
      
      - name: Check for changes
        id: check-changes
        run: |
          if [[ "${{ inputs.dry-run }}" == "true" ]]; then
            echo "Dry run mode - no changes to commit"
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            if git diff --quiet; then
              echo "No changes detected"
              echo "has-changes=false" >> $GITHUB_OUTPUT
            else
              echo "Changes detected"
              echo "has-changes=true" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Create Pull Request
        id: create-pr
        if: steps.check-changes.outputs.has-changes == 'true' && inputs.create-pr == true && inputs.dry-run == false
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.token || github.token }}
          commit-message: ${{ inputs.commit-message }}
          title: ${{ inputs.pr-title }}
          body: ${{ inputs.pr-body }}
          branch: ${{ inputs.branch-name }}
          labels: ${{ inputs.pr-labels }}
          delete-branch: true
          reviewers: |
            ${{ github.repository_owner }}
      
      - name: Output results
        run: |
          echo "Changes made: ${{ steps.update.outputs.changes-made }}"
          if [[ "${{ steps.create-pr.outputs.pull-request-number }}" != "" ]]; then
            echo "Pull request created: #${{ steps.create-pr.outputs.pull-request-number }}"
            echo "Pull request URL: ${{ steps.create-pr.outputs.pull-request-url }}"
          fi
      
      - name: Summary
        run: |
          echo "## 🤖 GitHub Actions Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files processed**: ${{ inputs.files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes made**: ${{ steps.update.outputs.changes-made }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run**: ${{ inputs.dry-run }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.create-pr.outputs.pull-request-url }}" != "" ]]; then
            echo "- **Pull request**: [${{ steps.create-pr.outputs.pull-request-number }}](${{ steps.create-pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
          fi